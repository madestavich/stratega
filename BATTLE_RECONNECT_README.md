# üõ°Ô∏è Battle Reconnect System

> –°–∏—Å—Ç–µ–º–∞ –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å—É –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—ñ–¥ —á–∞—Å –±–æ—é

## üìñ –®–≤–∏–¥–∫–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è

- **–®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç:** [`QUICK_START_BATTLE_RECONNECT.md`](QUICK_START_BATTLE_RECONNECT.md)
- **–ü–æ–≤–Ω–∏–π –æ–ø–∏—Å:** [`BATTLE_RECONNECT_SUMMARY.md`](BATTLE_RECONNECT_SUMMARY.md)
- **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** [`BATTLE_RECONNECT_TEST.md`](BATTLE_RECONNECT_TEST.md)
- **Flow –¥—ñ–∞–≥—Ä–∞–º–∏:** [`BATTLE_RECONNECT_FLOW.md`](BATTLE_RECONNECT_FLOW.md)
- **Checklist:** [`BATTLE_RECONNECT_CHECKLIST.md`](BATTLE_RECONNECT_CHECKLIST.md)

## üéØ –©–æ —Ü–µ –≤–∏—Ä—ñ—à—É—î?

### –ü—Ä–æ–±–ª–µ–º–∞:

- –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—ñ–¥ —á–∞—Å –±–æ—é —Å–∫–∏–¥–∞–ª–æ –≤—Å–µ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
- –†—ñ–∑–Ω–∏—Ü—è –≤ —Ç–∞–π–º—ñ–Ω–≥—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –º—ñ–∂ –≥—Ä–∞–≤—Ü—è–º–∏
- –†–æ–∑—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ä–∞—É–Ω–¥—ñ–≤

### –†—ñ—à–µ–Ω–Ω—è:

- ‚úÖ –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
- ‚úÖ –†–µ–∂–∏–º –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–ª—è reconnect –≥—Ä–∞–≤—Ü—è
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–∏—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –±–æ—é

## üöÄ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?

### 1. –ù–æ—Ä–º–∞–ª—å–Ω–∏–π –±—ñ–π (–±–µ–∑ reconnect)

```
–û–±–∏–¥–≤–∞ –≥–æ—Ç–æ–≤—ñ ‚Üí –ë—ñ–π ‚Üí –ü–µ—Ä–µ–º–æ–∂–µ—Ü—å ‚Üí –ù–æ–≤–∏–π —Ä–∞—É–Ω–¥
```

### 2. –ó reconnect

```
–ì—Ä–∞–≤–µ—Ü—å A –æ–Ω–æ–≤–∏–≤ ‚Üí Overlay "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è" ‚Üí
–ì—Ä–∞–≤–µ—Ü—å B –∑–∞–≤–µ—Ä—à—É—î ‚Üí –û–±–∏–¥–≤–∞ –±–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –ù–æ–≤–∏–π —Ä–∞—É–Ω–¥
```

## üì¶ –©–æ –≤—Ö–æ–¥–∏—Ç—å?

### –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

- **–§–∞–π–ª:** `server/migrations/add_battle_state.sql`
- **–ü–æ–ª—è:** battle_started, player1_in_battle, player2_in_battle (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ—Å–Ω—É—é—á–∏–π winner_id)

### Backend

- **–§–∞–π–ª:** `server/room.php`
- **Endpoints:** set_battle_state, get_battle_state, check_battle_completion

### Frontend

- **JavaScript:** `game/gameManager.js` (reconnect logic)
- **CSS:** `game/style.css` (waiting overlay)
- **HTML:** Inline (–¥–∏–Ω–∞–º—ñ—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è)

## ‚ö° –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç (2 –∫—Ä–æ–∫–∏)

### –ö—Ä–æ–∫ 1: –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ SQL –º—ñ–≥—Ä–∞—Ü—ñ—é

```bash
cd server/migrations
mysql -u username -p database < add_battle_state.sql
```

### –ö—Ä–æ–∫ 2: –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏

1. –°—Ç–≤–æ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É
2. 2 –≥—Ä–∞–≤—Ü—è ‚Üí "–ì–û–¢–û–í–ò–ô"
3. –ü—ñ–¥ —á–∞—Å –±–æ—é ‚Üí F5
4. –ü–æ–±–∞—á–∏—Ç–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
5. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å ‚Üí overlay –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
6. –î—Ä—É–≥–∏–π –∑–∞–≤–µ—Ä—à—É—î ‚Üí –æ–±–∏–¥–≤–∞ –±–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞          | –ó–Ω–∞—á–µ–Ω–Ω—è        |
| ---------------- | --------------- |
| SQL –º—ñ–≥—Ä–∞—Ü—ñ—è     | 3 –Ω–æ–≤—ñ –ø–æ–ª—è     |
| PHP endpoints    | 3 –Ω–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó  |
| JS –º–µ—Ç–æ–¥–∏        | 6 –Ω–æ–≤–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ |
| CSS –∫–ª–∞—Å–∏        | 4 –Ω–æ–≤—ñ —Å—Ç–∏–ª—ñ    |
| Polling interval | 2 —Å–µ–∫—É–Ω–¥–∏       |

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Overlay –Ω–µ –∑–Ω–∏–∫–∞—î

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞, –º–æ–∂–ª–∏–≤–æ –ø–æ–º–∏–ª–∫–∞ –≤ polling

### –ü—Ä–æ–±–ª–µ–º–∞: –†—ñ–∑–Ω—ñ —Ä–∞—É–Ω–¥–∏ —É –≥—Ä–∞–≤—Ü—ñ–≤

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ `incrementRound()` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–º–æ–∂—Ü–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: SQL –ø–æ–º–∏–ª–∫–∞

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –ø–æ–ª—è –Ω–µ —ñ—Å–Ω—É—é—Ç—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ `IF NOT EXISTS`

## üìù –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ì—Ä–∞–≤–µ—Ü—å    ‚îÇ
‚îÇ  (Browser)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ checkBattleState()
       ‚îÇ setBattleState()
       ‚îÇ checkBattleCompletion()
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     SQL      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   room.php   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  game_rooms  ‚îÇ
‚îÇ  (Backend)   ‚îÇ              ‚îÇ   (MySQL)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                             ‚ñ≤
       ‚îÇ                             ‚îÇ
       ‚îÇ Polling (2s)                ‚îÇ State sync
       ‚îÇ                             ‚îÇ
       ‚ñº                             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ì—Ä–∞–≤–µ—Ü—å 2  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    State     ‚îÇ
‚îÇ  (Browser)   ‚îÇ   Updates    ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### Unit Tests

- [ ] `checkBattleState()` –ø–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å—Ç–∞–Ω
- [ ] `setBattleState()` –æ–Ω–æ–≤–ª—é—î –ë–î
- [ ] `checkBattleCompletion()` –¥–µ—Ç–µ–∫—Ç—É—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è

### Integration Tests

- [ ] Reconnect –ø—ñ–¥ —á–∞—Å –±–æ—é
- [ ] –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ –≥—Ä–∞–≤—Ü—è–º–∏
- [ ] –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–µ—Ä–µ–º–æ–∂–µ—Ü—å

### E2E Tests

- [ ] –ü–æ–≤–Ω–∏–π —Ä–∞—É–Ω–¥ –∑ reconnect
- [ ] –ö—ñ–ª—å–∫–∞ —Ä–∞—É–Ω–¥—ñ–≤ –ø—ñ–¥—Ä—è–¥
- [ ] Edge cases (–æ–±–∏–¥–≤–∞ reconnect)

## üìö –î–æ–¥–∞—Ç–∫–æ–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

- [API Endpoints](server/migrations/README.md)
- [Database Schema](server/migrations/add_battle_state.sql)
- [Test Scenarios](BATTLE_RECONNECT_TEST.md)

## ü§ù Contributing

–ü—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –Ω–æ–≤–∏—Ö —Ñ—ñ—á:

1. –û–Ω–æ–≤—ñ—Ç—å flow –¥—ñ–∞–≥—Ä–∞–º—É
2. –î–æ–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–∏
3. –û–Ω–æ–≤—ñ—Ç—å checklist
4. Commit –∑ –æ–ø–∏—Å–æ–º

## üìÑ License

[–í–∞—à–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è]

## üë• –ê–≤—Ç–æ—Ä–∏

- Implementation: [–í–∞—à–µ —ñ–º'—è]
- Testing: [–¢–µ—Å—Ç—É–≤–∞–ª—å–Ω–∏–∫–∏]
- Review: [Reviewers]

---

**Version:** 1.0.0  
**Last Updated:** November 15, 2025  
**Status:** ‚úÖ Production Ready
