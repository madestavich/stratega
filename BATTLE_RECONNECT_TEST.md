# Тестування системи battle reconnect

## Послідовність тестування:

### 1. Підготовка

- Застосуйте SQL міграцію з `server/migrations/add_battle_state.sql`
- Переконайтеся що обидва гравця в лобі і готові почати бій

### 2. Тест базового попередження

1. Обидва гравця натискають "ГОТОВИЙ"
2. Бій розпочався (юніти рухаються/атакують)
3. Спробуйте оновити сторінку (F5 або Ctrl+R)
4. **Очікуваний результат**: Браузер покаже попередження "Бій активний! Якщо ви оновите сторінку..."
5. Натисніть "Скасувати" і продовжіть бій

### 3. Тест reconnect під час бою

1. Обидва гравця натискають "ГОТОВИЙ"
2. Бій розпочався
3. **Гравець 1**: оновіть сторінку (підтвердіть попередження)
4. **Очікуваний результат для Гравця 1**:
   - Сторінка перезавантажилась
   - Показується overlay "Очікування завершення бою"
   - Спінер обертається
   - Гра на паузі
5. **Гравець 2**: продовжує бій до кінця
6. **Коли Гравець 2 завершує бій**:
   - Гравець 2 бачить вікно переможця
   - Гравець 1 (після ~2 секунд) також бачить вікно переможця
   - Обидва гравці переходять в режим підготовки нового раунду

### 4. Тест обидва гравці оновили

1. Обидва гравця натискають "ГОТОВИЙ"
2. Бій розпочався
3. **Обидва гравця**: оновіть сторінку
4. **Очікуваний результат**:
   - Обидва бачать overlay очікування
   - Через певний час (коли сервер зрозуміє що обидва offline) може знадобитись перезапуск кімнати
   - Це edge case - рекомендується хоча б одному гравцю завершити бій

### 5. Перевірка синхронізації

1. Завершіть декілька раундів
2. Оновіть сторінку під час бою
3. **Перевірте**:
   - Номер раунду однаковий для обох гравців
   - Гроші синхронізовані
   - Юніти в правильних позиціях після reset

## Можливі проблеми:

### Overlay не зникає після завершення бою

- Перевірте консоль на помилки
- Перевірте що `check_battle_completion` endpoint працює
- Можливо потрібно оновити сторінку вручну

### Різні раунди у гравців

- Це означає десинхронізацію
- Перевірте що `last_round_winner_id` правильно зберігається
- Можливо потрібно перезапустити кімнату

### Попередження не показується

- Перевірте що `isPaused = false` під час бою
- Перевірте консоль браузера на помилки

## Логи для перевірки:

Відкрийте консоль браузера (F12) і шукайте:

- `"Reconnected during battle - entering waiting mode"`
- `"Battle completed by other player!"`
- `"Mark current player as in battle"`
- `"Mark player as no longer in battle"`
