# Battle Reconnect System - –†–µ–∑—é–º–µ –∑–º—ñ–Ω

## üéØ –©–æ –±—É–ª–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:

### –ü—Ä–æ–±–ª–µ–º–∏ –î–û:

- ‚ùå –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—ñ–¥ —á–∞—Å –±–æ—é —Å–∫–∏–¥–∞–ª–æ –≤—Å–µ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
- ‚ùå –í–µ–ª–∏–∫–∞ —Ä—ñ–∑–Ω–∏—Ü—è –≤ —Ç–∞–π–º—ñ–Ω–≥—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –º—ñ–∂ –≥—Ä–∞–≤—Ü—è–º–∏
- ‚ùå –¢–∞–π–º–µ—Ä —Å–∫–∏–¥–∞–≤—Å—è –∫–æ–ª–∏ —ñ–Ω—à–∏–π –≥—Ä–∞–≤–µ—Ü—å –∑–∞–≤–µ—Ä—à—É–≤–∞–≤ –±—ñ–π
- ‚ùå –†–æ–∑—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ä–∞—É–Ω–¥—ñ–≤ –º—ñ–∂ –≥—Ä–∞–≤—Ü—è–º–∏

### –†—ñ—à–µ–Ω–Ω—è –ü–Ü–°–õ–Ø:

- ‚úÖ –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—ñ–¥ —á–∞—Å –±–æ—é
- ‚úÖ –Ø–∫—â–æ –æ–Ω–æ–≤–∏–ª–∏ - –≥—Ä–∞–≤–µ—Ü—å —á–µ–∫–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –±–æ—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–º
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–∏—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è reconnect

## üìù –©–æ –±—É–ª–æ –∑–º—ñ–Ω–µ–Ω–æ:

### 1. –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (`server/migrations/add_battle_state.sql`)

–î–æ–¥–∞–Ω–æ –Ω–æ–≤—ñ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—é `game_rooms`:

- `battle_started` - —á–∏ —Ä–æ–∑–ø–æ—á–∞–≤—Å—è –±—ñ–π
- `player1_in_battle` - —á–∏ –≥—Ä–∞–≤–µ—Ü—å 1 –≤ –±–æ—é
- `player2_in_battle` - —á–∏ –≥—Ä–∞–≤–µ—Ü—å 2 –≤ –±–æ—é

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —ñ—Å–Ω—É—é—á–µ –ø–æ–ª–µ `winner_id` –¥–ª—è –ø–µ—Ä–µ–º–æ–∂—Ü—è —Ä–∞—É–Ω–¥—É.

### 2. Backend (`server/room.php`)

–î–æ–¥–∞–Ω–æ –Ω–æ–≤—ñ endpoints:

- `set_battle_state` - –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω –±–æ—é –¥–ª—è –≥—Ä–∞–≤—Ü—è
- `get_battle_state` - –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –±–æ—é
- `check_battle_completion` - –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –±—ñ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ

–û–Ω–æ–≤–ª–µ–Ω–æ —ñ—Å–Ω—É—é—á—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:

- `incrementRound()` - —Ç–µ–ø–µ—Ä —Å–∫–∏–¥–∞—î battle state —ñ –∑–±–µ—Ä—ñ–≥–∞—î winner_id
- `resetReadyStatus()` - —Å–∫–∏–¥–∞—î battle state –ø—Ä–∏ –Ω–æ–≤–æ–º—É —Ä–∞—É–Ω–¥—ñ

### 3. Frontend (`game/gameManager.js`)

–î–æ–¥–∞–Ω–æ –Ω–æ–≤—É –ª–æ–≥—ñ–∫—É:

- `beforeunload` event - –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É
- `checkBattleState()` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –º–∏ reconnect –ø—ñ–¥ —á–∞—Å –±–æ—é
- `handleBattleDisconnection()` - –æ–±—Ä–æ–±–∫–∞ reconnect
- `setBattleState()` - –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –≤ –ë–î
- `checkBattleCompletion()` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –±–æ—é
- `showWaitingForBattleMessage()` - –ø–æ–∫–∞–∑ overlay –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
- `hideWaitingForBattleMessage()` - –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è overlay

–û–Ω–æ–≤–ª–µ–Ω–æ —ñ—Å–Ω—É—é—á—ñ –º–µ—Ç–æ–¥–∏:

- `start()` - –ø–µ—Ä–µ–≤—ñ—Ä—è—î battle state –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
- `startGame()` - –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –≥—Ä–∞–≤—Ü—è —è–∫ "–≤ –±–æ—é"
- `endRound()` - –∑–Ω—ñ–º–∞—î —Å—Ç–∞—Ç—É—Å "–≤ –±–æ—é"

### 4. Styling (`game/style.css`)

–î–æ–¥–∞–Ω–æ —Å—Ç–∏–ª—ñ –¥–ª—è:

- `.battle-waiting-overlay` - —Ç–µ–º–Ω–∏–π overlay –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω
- `.battle-waiting-content` - –≤—ñ–∫–Ω–æ –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
- `.battle-waiting-spinner` - –∞–Ω—ñ–º–æ–≤–∞–Ω–∏–π —Å–ø—ñ–Ω–µ—Ä
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ —Å—Ç–∏–ª—ñ

## üîÑ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∏–π –±—ñ–π (–±–µ–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è)

1. –û–±–∏–¥–≤–∞ –≥—Ä–∞–≤—Ü—è –≥–æ—Ç–æ–≤—ñ ‚Üí –±—ñ–π –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è
2. `setBattleState(true)` –¥–ª—è –æ–±–æ—Ö
3. –ë—ñ–π –π–¥–µ...
4. –û–¥–∏–Ω –∑ –≥—Ä–∞–≤—Ü—ñ–≤ –ø–µ—Ä–µ–º–∞–≥–∞—î
5. `setBattleState(false)` + `incrementRound()`
6. –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è –ø–µ—Ä–µ–º–æ–∂–µ—Ü—å –æ–±–æ–º –≥—Ä–∞–≤—Ü—è–º
7. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥—É

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: Reconnect –ø—ñ–¥ —á–∞—Å –±–æ—é

1. –ì—Ä–∞–≤–µ—Ü—å A —ñ B –≤ –±–æ—é
2. –ì—Ä–∞–≤–µ—Ü—å A –æ–Ω–æ–≤–ª—é—î —Å—Ç–æ—Ä—ñ–Ω–∫—É (–ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è ‚Üí –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î)
3. –ì—Ä–∞–≤–µ—Ü—å A: `start()` ‚Üí `checkBattleState()` ‚Üí –≤–∏—è–≤–ª—è—î battle_started
4. –ì—Ä–∞–≤–µ—Ü—å A: `handleBattleDisconnection()`:
   - `setBattleState(false)` - –ø–æ–∑–Ω–∞—á–∞—î —Å–µ–±–µ —è–∫ –ù–ï –≤ –±–æ—é
   - –ü–æ–∫–∞–∑—É—î overlay "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è..."
   - –ó–∞–ø—É—Å–∫–∞—î —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ `checkBattleCompletion()` –∫–æ–∂–Ω—ñ 2 —Å–µ–∫
5. –ì—Ä–∞–≤–µ—Ü—å B –ø—Ä–æ–¥–æ–≤–∂—É—î –±—ñ–π...
6. –ì—Ä–∞–≤–µ—Ü—å B –ø–µ—Ä–µ–º–∞–≥–∞—î: `endRound()` ‚Üí `setBattleState(false)` ‚Üí `incrementRound()`
7. –ì—Ä–∞–≤–µ—Ü—å A (—á–µ—Ä–µ–∑ 2 —Å–µ–∫): `checkBattleCompletion()` ‚Üí –≤–∏—è–≤–ª—è—î —â–æ –±—ñ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ
8. –ì—Ä–∞–≤–µ—Ü—å A: —Ö–æ–≤–∞—î overlay, –ø–æ–∫–∞–∑—É—î –ø–µ—Ä–µ–º–æ–∂—Ü—è (–∑ `winner_id`), –ø—Ä–æ–¥–æ–≤–∂—É—î –≥—Ä—É

## üöÄ –Ø–∫ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏:

1. **–ó–∞—Å—Ç–æ—Å—É–π—Ç–µ –º—ñ–≥—Ä–∞—Ü—ñ—é –ë–î:**

   ```bash
   mysql -u username -p database_name < server/migrations/add_battle_state.sql
   ```

2. **–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–µ—Ä–≤–µ—Ä** (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)

3. **–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ** –∑–≥—ñ–¥–Ω–æ `BATTLE_RECONNECT_TEST.md`

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏:

- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ polling –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏ (–º–æ–∂–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ WebSocket'–∞–º–∏)
- –Ø–∫—â–æ –æ–±–∏–¥–≤–∞ –≥—Ä–∞–≤—Ü—ñ –æ–Ω–æ–≤–ª—è—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É - –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫—ñ–º–Ω–∞—Ç–∏
- Overlay –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∏–∫–∞—î –∫–æ–ª–∏ –±—ñ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- –í—Å—ñ –¥–∞–Ω—ñ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –ë–î

## üêõ Troubleshooting:

–Ø–∫—â–æ —â–æ—Å—å –Ω–µ –ø—Ä–∞—Ü—é—î:

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –º—ñ–≥—Ä–∞—Ü—ñ—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞ (`SHOW COLUMNS FROM game_rooms`)
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –ø–æ–º–∏–ª–∫–∏
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ PHP —Å–µ—Å—ñ—è –∞–∫—Ç–∏–≤–Ω–∞
4. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ –¥–ª—è debug –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
